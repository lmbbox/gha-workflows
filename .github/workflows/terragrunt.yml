---
name: Terragrunt

on:
  workflow_call:
    inputs:
      aws-region:
        description: The AWS region to use.
        default: ${{ vars.TERRAGRUNT_AWS_REGION || vars.AWS_REGION }}
        required: false
        type: string
      aws-role-to-assume:
        description: The AWS role to assume.
        default: ${{ vars.TERRAGRUNT_AWS_ROLE_TO_ASSUME || vars.AWS_ROLE_TO_ASSUME }}
        required: false
        type: string
      aws-role-to-chain:
        description: The second AWS role to assume.
        default: ${{ vars.TERRAGRUNT_AWS_ROLE_TO_CHAIN || vars.AWS_ROLE_TO_CHAIN }}
        required: false
        type: string
      aws-role-to-chain-external-id:
        description: The external ID of the second AWS role to assume.
        default: ""
        required: false
        type: string
      working-directory:
        description: The directory in which to run terragrunt from.
        default: ./
        required: false
        type: string
    secrets:
      SSH_DEPLOY_KEYS:
        description: Any additional ssh deploy keys that are needed.
        required: false

concurrency:
  group: ${{ inputs.working-directory }}
  cancel-in-progress: false

env:
  TG_NON_INTERACTIVE: true
  TG_PROVIDER_CACHE: true

jobs:
  terragrunt:
    name: Terragrunt ${{ inputs.working-directory }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    defaults:
      run:
        shell: gha-bash-wrapper {0}
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Setup Github Actions Bash Wrapper
        uses: lmbbox/gha-bash-wrapper@e1af0257b4d39865fda039c2d91d5c4a86b8e33e # ratchet:lmbbox/gha-bash-wrapper@v1.0.0

      - name: Setup SSH Agent
        if: env.SSH_DEPLOY_KEYS != ''
        env:
          SSH_DEPLOY_KEYS: ${{ secrets.SSH_DEPLOY_KEYS }}
        uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd # ratchet:webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ env.SSH_DEPLOY_KEYS }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # ratchet:aws-actions/configure-aws-credentials@v5.1.1
        with:
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ inputs.aws-role-to-assume }}

      - name: Configure Chained AWS Credentials
        if: inputs.aws-role-to-chain != ''
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # ratchet:aws-actions/configure-aws-credentials@v5.1.1
        with:
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ inputs.aws-role-to-chain }}
          role-external-id: ${{ inputs.aws-role-to-chain-external-id }}
          role-chaining: true
          role-skip-session-tagging: true

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # ratchet:aws-actions/amazon-ecr-login@v2.0.1

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v6.0.1

      - name: Setup Mise Tools
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # ratchet:jdx/mise-action@v3.6.1

      - name: Terragrunt HCL Format
        id: hclfmt
        continue-on-error: true
        run: terragrunt hcl format --check --diff

      - name: Terragrunt HCL Format TF & TFVars
        id: hclfmttfvars
        continue-on-error: true
        run: |
          failed=0
          for file in $(find . \( -name '*.tf' -o -name '*.tfvars' \) -not -path '*/.terragrunt-cache/*')
          do
            if ! terragrunt hcl format --check --diff --log-custom-format "%msg" --file $file
            then
              failed=1
            fi
          done
          exit $failed

      - name: Terragrunt HCL Validate
        id: hclval
        continue-on-error: true
        run: terragrunt hcl validate

      - name: Generate PR Comment File
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # ratchet:actions/github-script@v8.0.0
        env:
          HCLFMT: "${{ steps.hclfmt.outputs.stdouterr }}"
          HCLFMTTFVARS: "${{ steps.hclfmttfvars.outputs.stdouterr }}"
          HCLVAL: "${{ steps.hclval.outputs.stdouterr }}"
        with:
          script: |
            const fs = require('fs');
            const util = require('util')
            const filePath = '${{ runner.temp }}/pr-comment.md';
            const fileContent = `### Terragrunt
            <details>
            <summary>Format HCL üìù ${{ steps.hclfmt.outcome == 'success' && '‚úÖ' || '‚ùå' }}</summary>

            <pre>
            ${util.stripVTControlCharacters(process.env.HCLFMT).trim()}
            </pre>

            </details>

            <details>
            <summary>Format TF & TFVars üìù ${{ steps.hclfmttfvars.outcome == 'success' && '‚úÖ' || '‚ùå' }}</summary>

            <pre>
            ${util.stripVTControlCharacters(process.env.HCLFMTTFVARS).trim()}
            </pre>

            </details>

            <details>
            <summary>Validate HCL ü§ñ ${{ steps.hclval.outcome == 'success' && '‚úÖ' || '‚ùå' }} </summary>

            <pre>
            ${util.stripVTControlCharacters(process.env.HCLVAL).trim()}
            </pre>

            </details>

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*
            `;

            fs.writeFileSync(filePath, fileContent);

      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # ratchet:marocchino/sticky-pull-request-comment@v2.9.4
        with:
          header: hcl-${{ inputs.working-directory }}
          path: ${{ runner.temp }}/pr-comment.md

      - name: Check Status
        if: steps.hclfmt.outcome == 'failure' || steps.hclfmttfvars.outcome == 'failure' || steps.hclval.outcome == 'failure'
        run: exit 1

      - name: Restore Terragrunt Provider Cache
        id: restore-terragrunt-provider-cache
        uses: actions/cache/restore@9255dc7a253b0ccc959486e2bca901246202afeb # ratchet:actions/cache/restore@v5.0.1
        with:
          path: ~/.cache/terragrunt
          key: v1-terragrunt-provider-cache-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            v1-terragrunt-provider-cache-${{ runner.os }}-

      - name: Terragrunt TF Init
        id: init
        run: terragrunt run --all -- init

      - name: Save Terragrunt Provider Cache
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # ratchet:actions/cache/save@v5.0.1
        with:
          path: ~/.cache/terragrunt
          key: ${{ steps.restore-terragrunt-provider-cache.outputs.cache-primary-key }}

      - name: Terragrunt TF Validate
        id: validate
        continue-on-error: true
        run: terragrunt run --all -- validate

      - name: Terragrunt TF Plan
        id: plan
        if: github.event_name == 'pull_request'
        continue-on-error: true
        run: terragrunt run --all -- plan -lock-timeout=15m -out=tfplan

      - name: Terragrunt TF Show
        id: show
        if: github.event_name == 'pull_request'
        run: terragrunt run --all --tf-forward-stdout -- show tfplan 2>&1 | tee "${{ runner.temp }}/tfplan.log"

      - name: Generate PR Comment File
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # ratchet:actions/github-script@v8.0.0
        env:
          VALIDATE: "${{ steps.validate.outputs.stdouterr }}"
          PLAN_ERR: "${{ steps.plan.outputs.stderr }}"
        with:
          script: |
            const fs = require('fs');
            const util = require('util')
            const filePath = '${{ runner.temp }}/pr-comment.md';
            const planLog = fs.readFileSync('${{ runner.temp }}/tfplan.log', 'utf8');

            let planDetails = util.stripVTControlCharacters(planLog).trim();
            if (planDetails.length > 63000) {
              planDetails = planDetails.substring(0, 63000) + "...\n\nTruncated! See job for complete details."
            }

            const fileContent = `### Terragrunt ${{ inputs.working-directory }}
            #### Initialization ‚öôÔ∏è ${{ steps.init.outcome == 'success' && '‚úÖ' || '‚ùå' }}
            #### Validation ü§ñ ${{ steps.validate.outcome == 'success' && '‚úÖ' || '‚ùå' }}

            <details>
            <summary>Show</summary>

            <pre>
            ${util.stripVTControlCharacters(process.env.VALIDATE).trim()}
            </pre>

            </details>

            #### Plan üìñ ${{ steps.plan.outcome == 'success' && '‚úÖ' || '‚ùå' }}

            <details>
            <summary>Show</summary>

            <pre>
            ${util.stripVTControlCharacters(process.env.PLAN_ERR).trim()}
            ${planDetails}
            </pre>

            </details>

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*
            `;

            fs.writeFileSync(filePath, fileContent);

      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # ratchet:marocchino/sticky-pull-request-comment@v2.9.4
        with:
          header: terragrunt-${{ inputs.working-directory }}
          path: ${{ runner.temp }}/pr-comment.md

      - name: Terragrunt TF Plan Status
        if: steps.validate.outcome == 'failure' || steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terragrunt TF Apply
        if: github.ref_name == github.event.repository.default_branch
        run: terragrunt run --all -- apply -auto-approve -lock-timeout=15m
