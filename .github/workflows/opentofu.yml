---
name: Opentofu

on:
  workflow_call:
    inputs:
      aws-region:
        description: The AWS region to use.
        default: ${{ vars.OPENTOFU_AWS_REGION || vars.AWS_REGION }}
        required: false
        type: string
      aws-role-to-assume:
        description: The AWS role to assume.
        default: ${{ vars.OPENTOFU_AWS_ROLE_TO_ASSUME || vars.AWS_ROLE_TO_ASSUME }}
        required: false
        type: string
      aws-role-to-chain:
        description: The second AWS role to assume.
        default: ${{ vars.OPENTOFU_AWS_ROLE_TO_CHAIN || vars.AWS_ROLE_TO_CHAIN }}
        required: false
        type: string
      aws-role-to-chain-external-id:
        description: The external ID of the second AWS role to assume.
        default: ""
        required: false
        type: string
      pr-comment-always:
        description: If to always post a PR comment with results.
        default: false
        required: false
        type: boolean
      working-directory:
        description: The directory in which to run tofu from.
        required: true
        type: string
    secrets:
      tfvars:
        description: The content to append to the terraform.tfvars file.
        required: false

concurrency:
  group: ${{ inputs.working-directory }}
  cancel-in-progress: false

env:
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache

jobs:
  opentofu:
    name: Opentofu ${{ inputs.working-directory }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@00943011d9042930efac3dcd3a170e4273319bc8 # ratchet:aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ inputs.aws-role-to-assume }}

      - name: Configure Chained AWS Credentials
        if: inputs.aws-role-to-chain != ''
        uses: aws-actions/configure-aws-credentials@00943011d9042930efac3dcd3a170e4273319bc8 # ratchet:aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ inputs.aws-role-to-chain }}
          role-external-id: ${{ inputs.aws-role-to-chain-external-id }}
          role-chaining: true
          role-skip-session-tagging: true

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # ratchet:aws-actions/amazon-ecr-login@v2.0.1

      - name: Checkout the repository to the runner
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # ratchet:actions/checkout@v5.0.1

      - name: Setup Opentofu
        uses: opentofu/setup-opentofu@000eeb8522f0572907c393e8151076c205fdba1b # ratchet:opentofu/setup-opentofu@v1.0.6

      - name: Set additional tfvars
        if: env.TFVARS != ''
        env:
          TFVARS: ${{ secrets.tfvars }}
        run: |
          cat <<EOF >> terraform.tfvars
          # Added by GHA
          ${TFVARS}
          EOF

      - name: Restore Opentofu Plugin Cache
        id: restore-opentofu-plugin-cache
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache/restore@v4.3.0
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: v1-opentofu-plugin-cache-${{ hashFiles(format('{0}/.terraform.lock.hcl', inputs.working-directory)) }}
          restore-keys: |
            v1-opentofu-plugin-cache-${{ runner.os }}-

      - name: Opentofu Init
        id: init
        run: tofu init

      - name: Save Opentofu Plugin Cache
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache/save@v4.3.0
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: ${{ steps.restore-opentofu-plugin-cache.outputs.cache-primary-key }}

      - name: Opentofu Format
        id: fmt
        continue-on-error: true
        run: tofu fmt -check -diff

      - name: Opentofu Validate
        id: validate
        continue-on-error: true
        run: tofu validate

      - name: Opentofu Plan
        id: plan
        if: github.event_name == 'pull_request'
        continue-on-error: true
        run: tofu plan -detailed-exitcode -input=false -lock-timeout=15m -out=tfplan

      - name: Opentofu Show
        id: show
        if: github.event_name == 'pull_request'
        continue-on-error: true
        run: tofu show -plan=tfplan

      - name: Generate PR Comment File
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # ratchet:actions/github-script@v8.0.0
        env:
          FMT: "${{ steps.fmt.outputs.stdout }}\n${{ steps.fmt.outputs.stderr }}"
          VALIDATE: "${{ steps.validate.outputs.stdout }}\n${{ steps.validate.outputs.stderr }}"
          PLAN: "${{ steps.show.outputs.stdout }}\n${{ steps.show.outputs.stderr }}"
        with:
          script: |
            const fs = require('fs');
            const util = require('util')
            const filePath = '${{ runner.temp }}/pr-comment.md';

            let planDetails = util.stripVTControlCharacters(process.env.PLAN).trim()
            if (planDetails.length > 64000) {
              planDetails = planDetails.substring(0, 64000) + "...\n\nTruncated! See job for complete details."
            }

            const fileContent = `### Opentofu ${{ inputs.working-directory }}
            #### Initialization ‚öôÔ∏è\`${{ steps.init.outcome == 'success' && '‚úÖ' || '‚ùå' }}\`
            #### Format and Style üìù\`${{ steps.fmt.outcome == 'success' && '‚úÖ' || '‚ùå' }}\`

            <details>
            <summary>Show</summary>

            <pre>
            ${util.stripVTControlCharacters(process.env.FMT).trim()}
            </pre>

            </details>

            #### Validation ü§ñ\`${{ steps.validate.outcome == 'success' && '‚úÖ' || '‚ùå' }}\`

            <details>
            <summary>Show</summary>

            <pre>
            ${util.stripVTControlCharacters(process.env.VALIDATE).trim()}
            </pre>

            </details>

            #### Plan üìñ\`${{ steps.plan.outputs.exitcode == 2 && 'üöß' || (steps.plan.outcome == 'success' && '‚úÖ' || '‚ùå') }}\`

            <details>
            <summary>Show</summary>

            <pre>
            ${planDetails}
            </pre>

            </details>

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*
            `;

            fs.writeFileSync(filePath, fileContent);

      - name: Post PR Comment
        id: post-pr-comment
        if: github.event_name == 'pull_request' && inputs.pr-comment-always || (steps.init.outcome != 'success' || steps.fmt.outcome != 'success' || steps.validate.outcome != 'success' || steps.plan.outputs.exitcode != 0)
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # ratchet:marocchino/sticky-pull-request-comment@v2.9.4
        with:
          header: opentofu-${{ inputs.working-directory }}
          path: ${{ runner.temp }}/pr-comment.md

      - name: Delete Stale PR Comment
        if: github.event_name == 'pull_request' && steps.post-pr-comment.outcome == 'skipped'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # ratchet:marocchino/sticky-pull-request-comment@v2.9.4
        with:
          header: opentofu-${{ inputs.working-directory }}
          delete: true

      - name: Opentofu Status
        if: steps.fmt.outcome == 'failure' || steps.validate.outcome == 'failure' || steps.plan.outcome == 'failure'
        run: exit 1

      - name: Opentofu Apply
        if: github.ref_name == github.event.repository.default_branch
        run: tofu apply -auto-approve -input=false -lock-timeout=15m
